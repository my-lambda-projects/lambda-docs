Please enable JavaScript to view this page.

You must be logged in to view this page.

You must be a Lambda School student to view this page.

<a href="#content" id="skippy" class="sr-only sr-only-focusable"></a>

<span class="skiplink-text">Skip to main content</span>

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMyIgaGVpZ2h0PSIzNSIgdmlld2JveD0iMCAwIDMzIDM1IiBmaWxsPSJub25lIj4KICAgICAgICAgICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAwVjE2LjA2MDlDMCAyNy43MzM1IDkuMDg5MjkgMzEuNzg0MyAxNS43MzIxIDM0Ljc1MTNIMTUuNzVMMTYuMjg1NyAzNUMxNi40MTA3IDM0LjkyODkgMTYuNTM1NyAzNC44NzU2IDE2LjY3ODYgMzQuODIyM0MxNi43NSAzNC43ODY4IDE2LjgzOTMgMzQuNzUxMyAxNi45MTA3IDM0LjcxNTdDMjMuNTcxNCAzMS43NjY1IDMyLjY5NjQgMjcuNjk4IDMyLjY5NjQgMTYuMDYwOVYwSDBaTTIwLjcwNzEgMjMuNDUzNkwyMC4zNTcxIDIyLjUxMDJMMTUuNjA3MSAxMC4wNzM2QzE1LjMyMTQgMTAuODAyIDE0LjY2MDcgMTIuNTYwOSAxMy45NDY0IDE0LjQ0NDJMMTEuMjE0MyAyMS43ODE3QzExLjA4OTMgMjIuMTM3MSAxMS4xNjA3IDIyLjMxNDcgMTEuMjUgMjIuNDM5MUMxMS40NDY0IDIyLjY3MDEgMTEuODc2OCAyMi42NzAxIDEyLjU1NTQgMjIuNjcwMUgxMi42Nzg2TDEyLjY3NjggMjMuNDUxOEg3LjU2OTY0VjIyLjY3MDFINy45NjI1QzguNjU4OTMgMjIuNjcwMSA5LjIzMDM2IDIyLjM2OCA5LjY1ODkzIDIxLjUxNTJMMTAuMTc2OCAyMC4zNDI2TDE0LjkwODkgOC4yOTY5NkwxNC4wNjk2IDYuMDc2MTRIMTguNDgwNEwyNC41Njk2IDIyLjAxMjdMMjUuMTI1IDIzLjQ1MzZIMjAuNzA3MVoiIGZpbGw9IiNFQzM5NDQiPjwvcGF0aD4KICAgICAgICAgICAgICA8L3N2Zz4=" /></a>

![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdib3g9IjAgMCAzMCAzMCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmb2N1c2FibGU9ImZhbHNlIj4KICAgICAgICAgICAgICAgIDx0aXRsZT5NZW51PC90aXRsZT4KICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgZD0iTTQgN2gyMk00IDE1aDIyTTQgMjNoMjIiPjwvcGF0aD4KICAgICAgICAgICAgICA8L3N2Zz4=)

#### Web Annex

<a href="/webannex/sprint/recfwZvI7QhMa7xbG" class="bd-toc-link">1.  User Interface and Git</a>

- [User Interface](/webannex/module/recl0IyzS2Vl89lZa/)
- [Git for Web Development](/webannex/module/rect59e95N6OSvoCd/)
- [User Interface II](/webannex/module/recGvXyWT6AvGtMHR/)
- [User Interface III](/webannex/module/recaVbBZhh8BTyMdM/)

<a href="/webannex/sprint/recIXiQgpgMdJ81ms" class="bd-toc-link">2.  Advanced CSS</a>

- [Responsive Design I](/webannex/module/recuDrqSGpWcepCMs/)
- [Responsive Design II](/webannex/module/recE3IqPtDxaVI0DW/)
- [Preprocessing I](/webannex/module/reculyBhIYkuoBRqh/)
- [Preprocessing II](/webannex/module/rec1hRu3bO6L0uxn2/)

<a href="/webannex/sprint/recclZwJxMU8kUngT" class="bd-toc-link">3.  JavaScript Fundamentals</a>

- [JavaScript I](/webannex/module/recCT3KJYTIRYwQMh/)
- [JavaScript II](/webannex/module/rec1oaBmEoSilO2yf/)
- [Prototypes and Inheritance](/webannex/module/rec0AWuNLezbpit7m/)
- [Classes](/webannex/module/recyS588eOvVUKAMc/)

<a href="/webannex/sprint/recRT8JKvbTiGaosk" class="bd-toc-link">4.  Single Page Applications</a>

- [React Router I](/webannex/module/rec2TJ1vrdfcnx2EG/)
- [React Router II](/webannex/module/recYkF1FDilIedmwX/)
- [Form Management](/webannex/module/rect081xiYT2cfxGF/)
- [Advanced Form Management](/webannex/module/recKK5C7wV0WiECfr/)

<a href="/webannex/sprint/recozTHaHJe6L1ThN" class="bd-toc-link">5.  Authentication and Testing</a>

- [Introduction to Authentication](/webannex/module/recQD9lnhqWEFh6g4/)
- [Using Sessions and Cookies](/webannex/module/recvIPgHwxF194c7q/)
- [Using JSON Web Tokens (JWT)](/webannex/module/reciCHdNjavSKaaLt/)
- [Testing the Back End](/webannex/module/reciXdxRA8zXJXDID/)

---

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM1IiBoZWlnaHQ9IjM1IiB2aWV3Ym94PSIwIDAgNzU2IDE5NyIgZmlsbD0iI2VjMzk0NCI+CiAgICAgICAgICAgICAgPGc+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMjkyLjksMTI2LjZoLTYuN2MtOSwwLTEyLjYtMS45LTEyLjYtOS41VjQ4LjVjMC03LjcsMS42LTguNiwxMS40LTkuN3YtNC41aC00MS4zdjQuNSBjOS44LDEuMSwxMS40LDEuOSwxMS40LDkuN3Y2OS4zYzAsNy43LTEuNiw4LjYtMTEuNCw5Ljd2NC41aDczLjdsNC45LTI5LjRoLTQuNEMzMDguNSwxMTkuNiwzMDMuOSwxMjYuNiwyOTIuOSwxMjYuNnoiPgogICAgICAgICAgICAgICAgPC9wYXRoPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTM4NS41LDEyMS4xVjc5LjNjMC0xNS44LTkuNC0yMi40LTI2LjYtMjIuNGMtMTUsMC0yNi44LDYuNi0yNi44LDE5LjNjMCwyLjQsMC4yLDMuMywwLjgsNWgxNi42IGMtMC41LTItMC43LTUtMC43LTcuNWMwLTkuNiwzLjYtMTIuNCw5LjQtMTIuNGM2LjQsMCw5LjcsMiw5LjcsMTQuNHYxMS4ybC0yMC44LDcuN2MtMTAuNiw0LjEtMTkuMyw4LjgtMTkuMywyMC43IGMwLDEwLjksNy41LDE3LjgsMTguNiwxNy44YzkuOSwwLDE3LjQtNi4yLDIxLjktMTIuMWwwLjEtMC4xbDAsMFYxMzJoMjZ2LTQuNEMzODcuNywxMjcuMSwzODUuNSwxMjYuMiwzODUuNSwxMjEuMXogTTM2OCwxMTcuOCBjLTQuNCwzLjMtNy42LDUuMy0xMiw1LjRjLTcuNywwLTExLjItNS4yLTExLjItMTIuNmMwLTcuNywzLjYtMTEuMiw5LjgtMTMuNWwxMy40LTUuNFYxMTcuOEwzNjgsMTE3Ljh6Ij4KICAgICAgICAgICAgICAgIDwvcGF0aD4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik01MTQuNCwxMjFWNzkuNWMwLTE0LjgtNi0yMi40LTE4LjctMjIuNGMtMTEuNSwwLTE5LjQsNi42LTI1LjUsMTMuOWMtMS44LTkuNi03LjctMTMuOS0xNy44LTEzLjkgYy0xMS40LDAtMTguNyw2LjItMjQuOCwxMy42VjU3aC0yLjNsLTIzLjgsNy40djIuNGw4LjYsNXY0OS40YzAsNS0yLjEsNi4xLTguOSw2LjR2NC40aDM1LjF2LTQuNGMtNi43LTAuMy04LjctMS4zLTguNy02LjR2LTQ3IGM0LjctMy42LDkuNS02LjUsMTUuNS02LjVjNy42LDAsMTAuNSw0LjIsMTAuNSwxMi43djQwLjhjMCw1LTEuOSw2LjEtOC43LDYuNHY0LjRsMzQuOCwwdi00LjRjLTYuNy0wLjMtOC42LTEuMy04LjYtNi40di00NyBjNC43LTMuNiw5LjUtNi41LDE1LjUtNi41YzcuNiwwLDEwLjUsNC4yLDEwLjUsMTIuN2wtMC4xLDQwLjVjMCw1LTEuOCw2LjQtOC42LDYuN2wwLDQuNGgzNS4xdi00LjQgQzUxNi43LDEyNy40LDUxNC40LDEyNi4xLDUxNC40LDEyMXoiPgogICAgICAgICAgICAgICAgPC9wYXRoPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTU3My4yLDU3LjNjLTExLDAtMTguNSw1LjctMjMuNCwxMi44VjIyLjloLTIuN2wtMjMuNCw2Ljh2Mi41bDguNiw0LjVWMTMyaDIuOWw4LTMuNWM1LjgsMy4zLDEyLjMsNSwyMC4yLDUgYzIwLjgsMCwzNy40LTE1LjgsMzcuNC00Mi42QzYwMC45LDY5LjksNTkwLjQsNTcuMyw1NzMuMiw1Ny4zeiBNNTYzLjQsMTI4LjdjLTUuNCwwLTEwLjMtMi40LTEzLjctNy45VjczLjYgYzMuNC0zLjQsOC41LTUuNywxMy41LTUuN2MxMy45LDAsMjAsMTIuOCwyMCwyOS41QzU4My4zLDExNC43LDU3NS44LDEyOC41LDU2My40LDEyOC43eiI+CiAgICAgICAgICAgICAgICA8L3BhdGg+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNNjc3LDEyMS4yVjIyLjhoLTIuNkw2NTEsMjkuNlYzMmw4LjYsNC41djI1LjdjLTMuNC0zLjItOC44LTUuMS0xNS41LTUuMWMtMTkuOSwwLTM1LjIsMTUuMy0zNS4yLDQxLjMgYzAsMjAuNywxMS4yLDM0LjYsMjguMSwzNC42YzkuOCwwLDE3LTUuMywyMi42LTEzLjF2MC45VjEzMmgyNi4zbDAtNC40QzY3OS4xLDEyNy4zLDY3NywxMjYuMyw2NzcsMTIxLjJ6IE02NTkuNiwxMTcuMSBMNjU5LjYsMTE3LjFjLTMuNCwzLjQtOCw1LjEtMTMuMiw1LjFjLTEzLjIsMC0yMC40LTEyLjgtMjAuNC0yOS44YzAtMTcuOCw3LjMtMjkuMiwxOS41LTI5LjJjOC43LDAsMTQuMSw2LjksMTQuMSwxOC4zIEw2NTkuNiwxMTcuMXoiPgogICAgICAgICAgICAgICAgPC9wYXRoPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTc0Ny4xLDEyMS4xVjc5LjNjMC0xNS44LTkuNC0yMi40LTI2LjYtMjIuNGMtMTUsMC0yNi44LDYuNi0yNi44LDE5LjNjMCwyLjQsMC4yLDMuMywwLjgsNWgxNi42IGMtMC41LTItMC43LTUtMC43LTcuNWMwLTkuNiwzLjYtMTIuNCw5LjQtMTIuNGM2LjQsMCw5LjcsMiw5LjcsMTQuNHYxMS4ybC0yMC44LDcuN2MtMTAuNiw0LjEtMTkuMyw4LjgtMTkuMywyMC43IGMwLDEwLjksNy41LDE3LjgsMTguNiwxNy44YzkuOSwwLDE3LjQtNi4yLDIxLjktMTIuMXYtMC4xaDAuMWwwLDExLjFsMjYsMC4xdi00LjVDNzQ5LjMsMTI3LjEsNzQ3LjEsMTI2LjIsNzQ3LjEsMTIxLjF6IE03MjkuNiwxMTcuOGMtNC40LDMuMy03LjYsNS4zLTEyLjEsNS40Yy03LjcsMC0xMS4yLTUuMi0xMS4yLTEyLjZjMC03LjcsMy42LTExLjIsOS44LTEzLjVsMTMuNC01LjRMNzI5LjYsMTE3LjhMNzI5LjYsMTE3Ljh6Ij4KICAgICAgICAgICAgICAgIDwvcGF0aD4KICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgPHBhdGggZD0iTTAsMHY5MC40YzAsNjUuNyw1MC45LDg4LjUsODguMSwxMDUuMmgwLjFsMywxLjRjMC43LTAuNCwxLjQtMC43LDIuMi0xYzAuNC0wLjIsMC45LTAuNCwxLjMtMC42IGMzNy4zLTE2LjYsODguNC0zOS41LDg4LjQtMTA1VjBIMHogTTExNiwxMzJsLTItNS4zbC0yNi42LTcwYy0xLjYsNC4xLTUuMywxNC05LjMsMjQuNmwtMTUuMyw0MS4zYy0wLjcsMi0wLjMsMywwLjIsMy43IGMxLjEsMS4zLDMuNSwxLjMsNy4zLDEuM0g3MWwwLDQuNEg0Mi40bDAtNC40aDIuMmMzLjksMCw3LjEtMS43LDkuNS02LjVsMi45LTYuNmwyNi41LTY3LjhsLTQuNy0xMi41aDI0LjdsMzQuMSw4OS43bDMuMSw4LjFIMTE2eiI+CiAgICAgICAgICAgICAgPC9wYXRoPgogICAgICAgICAgICA8L3N2Zz4=" /></a>

#### Web Annex

<a href="/webannex/sprint/recfwZvI7QhMa7xbG" class="bd-toc-link">1.  User Interface and Git</a>

- [User Interface](/webannex/module/recl0IyzS2Vl89lZa/)
- [Git for Web Development](/webannex/module/rect59e95N6OSvoCd/)
- [User Interface II](/webannex/module/recGvXyWT6AvGtMHR/)
- [User Interface III](/webannex/module/recaVbBZhh8BTyMdM/)

<a href="/webannex/sprint/recIXiQgpgMdJ81ms" class="bd-toc-link">2.  Advanced CSS</a>

- [Responsive Design I](/webannex/module/recuDrqSGpWcepCMs/)
- [Responsive Design II](/webannex/module/recE3IqPtDxaVI0DW/)
- [Preprocessing I](/webannex/module/reculyBhIYkuoBRqh/)
- [Preprocessing II](/webannex/module/rec1hRu3bO6L0uxn2/)

<a href="/webannex/sprint/recclZwJxMU8kUngT" class="bd-toc-link">3.  JavaScript Fundamentals</a>

- [JavaScript I](/webannex/module/recCT3KJYTIRYwQMh/)
- [JavaScript II](/webannex/module/rec1oaBmEoSilO2yf/)
- [Prototypes and Inheritance](/webannex/module/rec0AWuNLezbpit7m/)
- [Classes](/webannex/module/recyS588eOvVUKAMc/)

<a href="/webannex/sprint/recRT8JKvbTiGaosk" class="bd-toc-link">4.  Single Page Applications</a>

- [React Router I](/webannex/module/rec2TJ1vrdfcnx2EG/)
- [React Router II](/webannex/module/recYkF1FDilIedmwX/)
- [Form Management](/webannex/module/rect081xiYT2cfxGF/)
- [Advanced Form Management](/webannex/module/recKK5C7wV0WiECfr/)

<a href="/webannex/sprint/recozTHaHJe6L1ThN" class="bd-toc-link">5.  Authentication and Testing</a>

- [Introduction to Authentication](/webannex/module/recQD9lnhqWEFh6g4/)
- [Using Sessions and Cookies](/webannex/module/recvIPgHwxF194c7q/)
- [Using JSON Web Tokens (JWT)](/webannex/module/reciCHdNjavSKaaLt/)
- [Testing the Back End](/webannex/module/reciXdxRA8zXJXDID/)

---

- [Prepare](#prepare)
- [Learn](#learn)
- [Guided Project](#guided-project)
- [Project](#project)
- [Review](#review)

# Testing the Back End

<span class="lead"> </span>

In this module, we learn how to add automated tests to an API.

**At the end of this module, you should be able to:**

- test Web API Endpoints
- test Data Access Code

#### Pro Tip

The more you know, the more you know you don’t know.

## <a href="#prepare" id="prepare" class="anchor"><span class="octicon octicon-link"></span></a>Prepare

Review each preclass resource before class.

- # An error occurred.

  [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=Hxzh6DaZnWk), or enable JavaScript if it is disabled in your browser.

- # An error occurred.

  [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=5V0sWOqTw2I), or enable JavaScript if it is disabled in your browser.

## <a href="#learn" id="learn" class="anchor"><span class="octicon octicon-link"></span></a>Learn

#### Learn to test Web API Endpoints

When building a Web API using _Express_, we use _unit testing_ to test the application logic and _integration testing_ to test the _route handlers_ and _middleware_.

We write tests to verify that the API endpoints return the expected values and HTTP status codes. We also write tests to make sure that we’re returning the data using the right format (HTML, XML, JSON) and several other things.

##### Overview

The tests we write for endpoints are called _integration tests_ because they test how different parts of the system work together. This is different from the _unit tests_ we use to verify the correctness of one part of the system in isolation.

We’ll use a `npm` module called [supertest](https://github.com/visionmedia/supertest) that makes it easier to write tests for Node.js HTTP servers. We can use `supertest` to load an instance of our server, send requests to the different endpoints, and make assertions about the responses.

We could use `supertest` to verify that making a `POST` request to a particular endpoint returns a `201` HTTP status code after successfully creating a _resource_ or, that it returns a `500` code if the server ran into an error while processing the request. Writing such a test may look like this:

1.  Save a reference to the server.
2.  Use `supertest` to make a POST request passing correct data inside the body.
3.  Check that the server responds with status code 201.

Writing such a test verifies that all _middleware_, including the _route handler_ is working as intended.

##### Follow Along

Please follow along as we configure our testing environment, write a simple endpoint, and the corresponding tests for it.

Create a folder and configure our testing environment.

- Create a new folder and `cd` into it.

- Type `git init` to initialize a git repository to help _jest_ detect changes.

- Initialize it with a `package.json` by running `npm init -y` in our terminal.

- Use `npm` to add `express` as a regular dependency and `jest` and `supertest` as **development dependencies**.

- Add a _test_ script inside `package.json` that runs our tests: `"test": "jest --watch --verbose"`.

- Configure _jest_ to run in _node mode_ since we’ll be running in _Node.js_.

  - inside `package.json` add a property called `jest` and configure it like this:

    "jest": {
    "testEnvironment": "node"
    }

We have all we need to start working on our API. Begin by adding a file that holds tests for our server, call it `server.spec.js` and add the following code.

    /*
    - when making a GET request to the `/` endpoint
      the API should respond with status code 200
      and the following JSON object: `{ api: 'running' }`.
    */
    const request = require('supertest'); // calling it "request" is a common practice

    const server = require('./server.js'); // this is our first red, file doesn't exist yet

    describe('server.js', () => {
      // http calls made with supertest return promises, we can use async/await if desired
      describe('index route', () => {
        it('should return an OK status code from the index route', async () => {
          const expectedStatusCode = 200;

          // do a get request to our api (server.js) and inspect the response
          const response = await request(server).get('/');

          expect(response.status).toEqual(expectedStatusCode);

          // same test using promise .then() instead of async/await
          // let response;
          // return request(server).get('/').then(res => {
          //   response = res;

          //   expect(response.status).toEqual(expectedStatusCode);
          // })
        });

        it('should return a JSON object from the index route', async () => {
          const expectedBody = { api: 'running' };

          const response = await request(server).get('/');

          expect(response.body).toEqual(expectedBody);
        });

        it('should return a JSON object from the index route', async () => {
          const response = await request(server).get('/');

          expect(response.type).toEqual('application/json');
        });
      });
    });

In this code, we consider three questions commonly tested for our endpoints:

- Does it return the correct status code for the input provided?
- Does it return the data in the expected format?
- Does the data returned, if any, have the right content?

We are listing them all at once, but you will write one _test case_ at a time and complete any required _refactoring_ before writing the next test.

When testing your endpoints, start with those three tests and then move on to write tests that are unique for the system you’re building. The _payroll_ endpoints for an accounting system, for example, require different tests than those for an _accounts payable_ module. **There is no one size fit’s all when it comes to testing**. Each system will have its own set of requirements that all require verification.

Create the `server.js` file and add the following code to make the tests pass:

    const express = require('express');

    const server = express();

    server.get('/', (req, res) => {
      res.status(200).json({ api: 'running' });
    });

    module.exports = server;

Notice we are not starting the server with `server.listen(port)`, This is a common pattern. We separate the server implementation from the code that _runs_ the server. If we start listening for requests in this file, then every time a test runs, it will start a new instance of the API using the specified port and run into an _“address (meaning the port number) in use”_ error. Using this technique, we avoid those types of errors and decouple two different concerns: 1) building a server and 2) using a server to listen for requests.

##### Challenge

Use TDD to implement a `/sing` endpoint that returns the string “I believe I can fly, I believe I can test an A-P-I!”.

##### Dig Deeper

- [Types of Tests](https://kentcdodds.com/blog/unit-vs-integration-vs-e2e-tests)
- [Server Testing](https://github.com/LambdaSchool/Server-Testing)  
  The full assignment for Server testing

---

#### Learn to test Data Access Code

Most Web APIs include a data store, often a database of some kind. It is recommended to test the code that interacts with the database to prevent defects and reduce the risk of _regressions_.

##### Overview

To test the data access, we’ll write _end to end_ tests. These types of tests run slower because they perform operations and run queries against an actual database that is similar to the one used in production.

To avoid polluting the development database, we’ll use a separate database for testing. One advantage of using a dedicated testing database is that we can add and remove records without affecting the data in the development or staging databases.

Next, we’ll walk through setting up our API to switch to the testing database based on an _environment variable_, including how to set a different value for that environment value only when running tests.

##### Follow Along

### Using cross-env

Setting and using environment variables is different for windows and POSIX (Mac, Linux, Unix) Operating Systems. We can use [cross-env](https://www.npmjs.com/package/cross-env), an npm module that deals with the OS inconsistencies and provides a uniform way of setting environment variables across all platforms.

Open `package.json` and look at the `test` script. It uses `cross-env` to set an environment variable with the key `DB_ENV` and the value: _testing_.

    "test": "cross-env DB_ENV=testing jest --watch"

This environment variable is available to the API as `process.env.DB_ENV`. The sample code provided uses it inside `./data/dbConfig.js` to choose which configuration object to use for the `knex` connection.

    // ./data/dbConfig.js
    const knex = require('knex');

    const config = require('../knexfile.js');

    // if the environment variable is not set, default to 'development'
    // this variable is only set when running the "test" npm script using npm run test
    const dbEnv = process.env.DB_ENV || 'development';

    // the value of dbEnv will be either 'development' or 'testing'
    // we pass it within brackets to select the corresponding configuration
    // from knexfile.js
    module.exports = knex(config[dbEnv]);

To make this work, `knexfile.js` has a dedicated configuration key for _testing_.

    // ./knexfile.js

    module.exports = {
      development: {
        client: 'sqlite3',
        connection: {
          filename: './data/hobbits.db3',
        },
        useNullAsDefault: true,
        migrations: {
          directory: './data/migrations',
        },
        seeds: {
          directory: './data/seeds',
        },
      },
      testing: {
        client: 'sqlite3',
        connection: {
          filename: './data/test.db3',
        },
        useNullAsDefault: true,
        migrations: {
          directory: './data/migrations',
        },
        seeds: {
          directory: './data/seeds',
        },
      },
    };

### Using Different Environments for Knex Migrations and Seeding

Different databases have different configuration objects defined within `knexfile.js`. To specify which environment to target during _migrations_ and _seeding_ use the `--env` command-line argument.

To run migrations against the _testing_ database, use the following command.

    npx knex migrate:latest --env=testing

To run seeds against the _testing_ database, use the following command.

    npx knex seed:run --env=testing

### Write End to End Tests that Involve the Database

To test the data access code, execute the data access and then verify that the database was updated correctly.

In this example, the data access code has an `.insert()` method. Let’s see how to test it.

    // our connection to the database
    const db = require('../data/dbConfig.js');

    // the data access file we are testing
    const Hobbits = require('./hobbitsModel.js');

    describe('hobbits model', () => {
      describe('insert()', () => {
        // this example uses async/await to make it easier to read and understand
        it('should insert the provided hobbits into the db', async () => {
          // this code expects that the table is empty, we'll handle that below
          // add data to the test database using the data access file
          await Hobbits.insert({ name: 'gaffer' });
          await Hobbits.insert({ name: 'sam' });

          // read data from the table
          const hobbits = await db('hobbits');

          // verify that there are now two records inserted
          expect(hobbits).toHaveLength(2);
        });
      });
    });

To guarantee that the tables are cleared before running each test, add the following code before the test cases.

    beforeEach(async () => {
      // this function executes and clears out the table before each test
      await db('hobbits').truncate();
    });

Implement code to make the tests pass.

    // ./hobbits/hobbitsModel.js
    async function insert(hobbit) {
      // the second parameter here is of other databases, SQLite returns the id by default
      const [id] = await db('hobbits').insert(hobbit, 'id');

      return db('hobbits')
        .where({ id })
        .first();
    }

This tests only checks that there are two records added to the table, even if those records were there at the beginning.

Let’s add another test to make sure that the record is making it to the database and that the `.insert()` method returns the newly inserted hobbit.

    // note we're checking one hobbit at a time
    it('should insert the provided hobbit into the db', async () => {
      let hobbit = await Hobbits.insert({ name: 'gaffer' });
      expect(hobbit.name).toBe('gaffer');

      // note how we're reusing the hobbit variable
      hobbit = await Hobbits.insert({ name: 'sam' });
      expect(hobbit.name).toBe('sam');
    });

##### Challenge

- Write the commands to run migrations and seeds using the “production” configuration for knex.
- Write two tests for one of the projects from past modules of this sprint.

---

## <a href="#guided-project" id="guided-project" class="anchor"><span class="octicon octicon-link"></span></a>Guided Project

### Node Server Testing Guided

Guided Project for Node Server Testing

[GitHub Repo](https://github.com/LambdaSchool/node-server-testing-guided)

---

## <a href="#project" id="project" class="anchor"><span class="octicon octicon-link"></span></a>Project

- ##### [Node Server Testing Challenge](https://github.com/LambdaSchool/node-server-testing-challenge)

  Challenge for Node Server Testing Module

## <a href="#review" id="review" class="anchor"><span class="octicon octicon-link"></span></a>Review

### Class Recordings

You can use class recordings to help you master the material.

- **[Testing the Back End for Web PT 18 w/Jason Maurer](https://youtu.be/HvFOtG35rUM)**

  In this module, we learn how to add automated tests to an API. At the end of this module, you should be able to: test Web API Endpoints test Data Access Code

- [All previous recordings](/archive/FSW/module/reciXdxRA8zXJXDID)

### Demonstrate Mastery

To demonstrate mastery of this module, you need to complete and pass a code review on each of the following:

- Objective challenge:

  Use TDD to implement a `/sing` endpoint that returns the string “I believe I can fly, I believe I can test an A-P-I!”.

- Objective challenge:

  - Write the commands to run migrations and seeds using the “production” configuration for knex.
  - Write two tests for one of the projects from past modules of this sprint.

- Guided Project: Node Server Testing Guided

- Project: Node Server Testing Challenge
