Please enable JavaScript to view this page.

You must be logged in to view this page.

You must be a Lambda School student to view this page.

<a href="#content" id="skippy" class="sr-only sr-only-focusable"></a>

<span class="skiplink-text">Skip to main content</span>

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMyIgaGVpZ2h0PSIzNSIgdmlld2JveD0iMCAwIDMzIDM1IiBmaWxsPSJub25lIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0wIDBWMTYuMDYwOUMwIDI3LjczMzUgOS4wODkyOSAzMS43ODQzIDE1LjczMjEgMzQuNzUxM0gxNS43NUwxNi4yODU3IDM1QzE2LjQxMDcgMzQuOTI4OSAxNi41MzU3IDM0Ljg3NTYgMTYuNjc4NiAzNC44MjIzQzE2Ljc1IDM0Ljc4NjggMTYuODM5MyAzNC43NTEzIDE2LjkxMDcgMzQuNzE1N0MyMy41NzE0IDMxLjc2NjUgMzIuNjk2NCAyNy42OTggMzIuNjk2NCAxNi4wNjA5VjBIMFpNMjAuNzA3MSAyMy40NTM2TDIwLjM1NzEgMjIuNTEwMkwxNS42MDcxIDEwLjA3MzZDMTUuMzIxNCAxMC44MDIgMTQuNjYwNyAxMi41NjA5IDEzLjk0NjQgMTQuNDQ0MkwxMS4yMTQzIDIxLjc4MTdDMTEuMDg5MyAyMi4xMzcxIDExLjE2MDcgMjIuMzE0NyAxMS4yNSAyMi40MzkxQzExLjQ0NjQgMjIuNjcwMSAxMS44NzY4IDIyLjY3MDEgMTIuNTU1NCAyMi42NzAxSDEyLjY3ODZMMTIuNjc2OCAyMy40NTE4SDcuNTY5NjRWMjIuNjcwMUg3Ljk2MjVDOC42NTg5MyAyMi42NzAxIDkuMjMwMzYgMjIuMzY4IDkuNjU4OTMgMjEuNTE1MkwxMC4xNzY4IDIwLjM0MjZMMTQuOTA4OSA4LjI5Njk2TDE0LjA2OTYgNi4wNzYxNEgxOC40ODA0TDI0LjU2OTYgMjIuMDEyN0wyNS4xMjUgMjMuNDUzNkgyMC43MDcxWiIgZmlsbD0iI0VDMzk0NCI+PC9wYXRoPgo8L3N2Zz4=" /></a>

![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdib3g9IjAgMCAzMCAzMCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmb2N1c2FibGU9ImZhbHNlIj48dGl0bGU+TWVudTwvdGl0bGU+PHBhdGggc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBkPSJNNCA3aDIyTTQgMTVoMjJNNCAyM2gyMiI+PC9wYXRoPjwvc3ZnPg==)

#### Computer Science Annex

<a href="/csannex/sprint/recMPt6jmsCgaqrfj" class="bd-toc-link">1.  Data Structures: Heaps</a>

-   [Heaps](/csannex/module/recNbOiLfM7bfQ0aE/)

<a href="/csannex/sprint/recKzV5STy8vYnbQ1" class="bd-toc-link">2.  Intro to Django</a>

-   [Django basics and setup](/csannex/module/recvCvXoZKm5cYOc4/)
-   [Building APIs](/csannex/module/recuEEEsf9eXphxy0/)

<a href="/csannex/sprint/recUHGX7arXkBIutr" class="bd-toc-link">3.  Python/Django I</a>

-   [Getting started with Python and Django](/csannex/module/rec4yg0hRHaeOmBGN/)
-   [Object-Oriented Programming](/csannex/module/recHhVqI4Y3j6UgLa/)
-   [Software Design Patterns](/csannex/module/recgVHqW0RShuQn1Z/)

<a href="/csannex/sprint/rec64nbdwB28JM7Qu" class="bd-toc-link">4.  Python/Django II/Career Development</a>

-   [REST](/csannex/module/rec7YHjLuXabdlhof/)
-   [GraphQL](/csannex/module/recjIPIwz5Pn5WbPh/)
-   [Model-View-Controller](/csannex/module/recVsikSMFoQ25WZd/)

<a href="/csannex/sprint/reczMSFEG5pffpADx" class="bd-toc-link">5.  Python/Django III/Career Development</a>

-   [Object-relational mapping](/csannex/module/reccrn1If8mhlIymc/)
-   [Relational Databases](/csannex/module/recU6Q1DLISGvt0dk/)

<a href="/csannex/sprint/recTTpwFpgZXtPG2o" class="bd-toc-link">6.  Project Week: Cellular Automata</a>

-   [Game of Life](/csannex/module/rec42j1bkTmC0Hsro/)

<a href="/csannex/sprint/recqkHjNcXzK5DTqd" class="bd-toc-link">7.  C Programming Topics</a>

-   [Introduction To C](/csannex/module/recLymrrD7f46rdBa/)
-   [Processes and System Calls](/csannex/module/rec7YmMV7ukDLK770/)
-   [Scheduling](/csannex/module/recfiYtQDLFXGOBFA/)
-   [Operating Systems](/csannex/module/recHPT5QiPS6NOCgz/)
-   [Web Server I](/csannex/module/recz76g3pcHs88Dax/)
-   [Web Server II](/csannex/module/recFGnBVmKCyR0427/)
-   [Theory of Computation](/csannex/module/recH0OAnSr6ZcnZ7F/)

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM1IiBoZWlnaHQ9IjM1IiB2aWV3Ym94PSIwIDAgNzU2IDE5NyIgZmlsbD0iI2VjMzk0NCI+PGc+PHBhdGggZD0iTTI5Mi45LDEyNi42aC02LjdjLTksMC0xMi42LTEuOS0xMi42LTkuNVY0OC41YzAtNy43LDEuNi04LjYsMTEuNC05Ljd2LTQuNWgtNDEuM3Y0LjUgYzkuOCwxLjEsMTEuNCwxLjksMTEuNCw5Ljd2NjkuM2MwLDcuNy0xLjYsOC42LTExLjQsOS43djQuNWg3My43bDQuOS0yOS40aC00LjRDMzA4LjUsMTE5LjYsMzAzLjksMTI2LjYsMjkyLjksMTI2LjZ6Ij48L3BhdGg+PHBhdGggZD0iTTM4NS41LDEyMS4xVjc5LjNjMC0xNS44LTkuNC0yMi40LTI2LjYtMjIuNGMtMTUsMC0yNi44LDYuNi0yNi44LDE5LjNjMCwyLjQsMC4yLDMuMywwLjgsNWgxNi42IGMtMC41LTItMC43LTUtMC43LTcuNWMwLTkuNiwzLjYtMTIuNCw5LjQtMTIuNGM2LjQsMCw5LjcsMiw5LjcsMTQuNHYxMS4ybC0yMC44LDcuN2MtMTAuNiw0LjEtMTkuMyw4LjgtMTkuMywyMC43IGMwLDEwLjksNy41LDE3LjgsMTguNiwxNy44YzkuOSwwLDE3LjQtNi4yLDIxLjktMTIuMWwwLjEtMC4xbDAsMFYxMzJoMjZ2LTQuNEMzODcuNywxMjcuMSwzODUuNSwxMjYuMiwzODUuNSwxMjEuMXogTTM2OCwxMTcuOCBjLTQuNCwzLjMtNy42LDUuMy0xMiw1LjRjLTcuNywwLTExLjItNS4yLTExLjItMTIuNmMwLTcuNywzLjYtMTEuMiw5LjgtMTMuNWwxMy40LTUuNFYxMTcuOEwzNjgsMTE3Ljh6Ij48L3BhdGg+PHBhdGggZD0iTTUxNC40LDEyMVY3OS41YzAtMTQuOC02LTIyLjQtMTguNy0yMi40Yy0xMS41LDAtMTkuNCw2LjYtMjUuNSwxMy45Yy0xLjgtOS42LTcuNy0xMy45LTE3LjgtMTMuOSBjLTExLjQsMC0xOC43LDYuMi0yNC44LDEzLjZWNTdoLTIuM2wtMjMuOCw3LjR2Mi40bDguNiw1djQ5LjRjMCw1LTIuMSw2LjEtOC45LDYuNHY0LjRoMzUuMXYtNC40Yy02LjctMC4zLTguNy0xLjMtOC43LTYuNHYtNDcgYzQuNy0zLjYsOS41LTYuNSwxNS41LTYuNWM3LjYsMCwxMC41LDQuMiwxMC41LDEyLjd2NDAuOGMwLDUtMS45LDYuMS04LjcsNi40djQuNGwzNC44LDB2LTQuNGMtNi43LTAuMy04LjYtMS4zLTguNi02LjR2LTQ3IGM0LjctMy42LDkuNS02LjUsMTUuNS02LjVjNy42LDAsMTAuNSw0LjIsMTAuNSwxMi43bC0wLjEsNDAuNWMwLDUtMS44LDYuNC04LjYsNi43bDAsNC40aDM1LjF2LTQuNCBDNTE2LjcsMTI3LjQsNTE0LjQsMTI2LjEsNTE0LjQsMTIxeiI+PC9wYXRoPjxwYXRoIGQ9Ik01NzMuMiw1Ny4zYy0xMSwwLTE4LjUsNS43LTIzLjQsMTIuOFYyMi45aC0yLjdsLTIzLjQsNi44djIuNWw4LjYsNC41VjEzMmgyLjlsOC0zLjVjNS44LDMuMywxMi4zLDUsMjAuMiw1IGMyMC44LDAsMzcuNC0xNS44LDM3LjQtNDIuNkM2MDAuOSw2OS45LDU5MC40LDU3LjMsNTczLjIsNTcuM3ogTTU2My40LDEyOC43Yy01LjQsMC0xMC4zLTIuNC0xMy43LTcuOVY3My42IGMzLjQtMy40LDguNS01LjcsMTMuNS01LjdjMTMuOSwwLDIwLDEyLjgsMjAsMjkuNUM1ODMuMywxMTQuNyw1NzUuOCwxMjguNSw1NjMuNCwxMjguN3oiPjwvcGF0aD48cGF0aCBkPSJNNjc3LDEyMS4yVjIyLjhoLTIuNkw2NTEsMjkuNlYzMmw4LjYsNC41djI1LjdjLTMuNC0zLjItOC44LTUuMS0xNS41LTUuMWMtMTkuOSwwLTM1LjIsMTUuMy0zNS4yLDQxLjMgYzAsMjAuNywxMS4yLDM0LjYsMjguMSwzNC42YzkuOCwwLDE3LTUuMywyMi42LTEzLjF2MC45VjEzMmgyNi4zbDAtNC40QzY3OS4xLDEyNy4zLDY3NywxMjYuMyw2NzcsMTIxLjJ6IE02NTkuNiwxMTcuMSBMNjU5LjYsMTE3LjFjLTMuNCwzLjQtOCw1LjEtMTMuMiw1LjFjLTEzLjIsMC0yMC40LTEyLjgtMjAuNC0yOS44YzAtMTcuOCw3LjMtMjkuMiwxOS41LTI5LjJjOC43LDAsMTQuMSw2LjksMTQuMSwxOC4zIEw2NTkuNiwxMTcuMXoiPjwvcGF0aD48cGF0aCBkPSJNNzQ3LjEsMTIxLjFWNzkuM2MwLTE1LjgtOS40LTIyLjQtMjYuNi0yMi40Yy0xNSwwLTI2LjgsNi42LTI2LjgsMTkuM2MwLDIuNCwwLjIsMy4zLDAuOCw1aDE2LjYgYy0wLjUtMi0wLjctNS0wLjctNy41YzAtOS42LDMuNi0xMi40LDkuNC0xMi40YzYuNCwwLDkuNywyLDkuNywxNC40djExLjJsLTIwLjgsNy43Yy0xMC42LDQuMS0xOS4zLDguOC0xOS4zLDIwLjcgYzAsMTAuOSw3LjUsMTcuOCwxOC42LDE3LjhjOS45LDAsMTcuNC02LjIsMjEuOS0xMi4xdi0wLjFoMC4xbDAsMTEuMWwyNiwwLjF2LTQuNUM3NDkuMywxMjcuMSw3NDcuMSwxMjYuMiw3NDcuMSwxMjEuMXogTTcyOS42LDExNy44Yy00LjQsMy4zLTcuNiw1LjMtMTIuMSw1LjRjLTcuNywwLTExLjItNS4yLTExLjItMTIuNmMwLTcuNywzLjYtMTEuMiw5LjgtMTMuNWwxMy40LTUuNEw3MjkuNiwxMTcuOEw3MjkuNiwxMTcuOHoiPjwvcGF0aD48L2c+PHBhdGggZD0iTTAsMHY5MC40YzAsNjUuNyw1MC45LDg4LjUsODguMSwxMDUuMmgwLjFsMywxLjRjMC43LTAuNCwxLjQtMC43LDIuMi0xYzAuNC0wLjIsMC45LTAuNCwxLjMtMC42IGMzNy4zLTE2LjYsODguNC0zOS41LDg4LjQtMTA1VjBIMHogTTExNiwxMzJsLTItNS4zbC0yNi42LTcwYy0xLjYsNC4xLTUuMywxNC05LjMsMjQuNmwtMTUuMyw0MS4zYy0wLjcsMi0wLjMsMywwLjIsMy43IGMxLjEsMS4zLDMuNSwxLjMsNy4zLDEuM0g3MWwwLDQuNEg0Mi40bDAtNC40aDIuMmMzLjksMCw3LjEtMS43LDkuNS02LjVsMi45LTYuNmwyNi41LTY3LjhsLTQuNy0xMi41aDI0LjdsMzQuMSw4OS43bDMuMSw4LjFIMTE2eiI+PC9wYXRoPjwvc3ZnPg==" /></a>

#### Computer Science Annex

<a href="/csannex/sprint/recMPt6jmsCgaqrfj" class="bd-toc-link">1.  Data Structures: Heaps</a>

-   [Heaps](/csannex/module/recNbOiLfM7bfQ0aE/)

<a href="/csannex/sprint/recKzV5STy8vYnbQ1" class="bd-toc-link">2.  Intro to Django</a>

-   [Django basics and setup](/csannex/module/recvCvXoZKm5cYOc4/)
-   [Building APIs](/csannex/module/recuEEEsf9eXphxy0/)

<a href="/csannex/sprint/recUHGX7arXkBIutr" class="bd-toc-link">3.  Python/Django I</a>

-   [Getting started with Python and Django](/csannex/module/rec4yg0hRHaeOmBGN/)
-   [Object-Oriented Programming](/csannex/module/recHhVqI4Y3j6UgLa/)
-   [Software Design Patterns](/csannex/module/recgVHqW0RShuQn1Z/)

<a href="/csannex/sprint/rec64nbdwB28JM7Qu" class="bd-toc-link">4.  Python/Django II/Career Development</a>

-   [REST](/csannex/module/rec7YHjLuXabdlhof/)
-   [GraphQL](/csannex/module/recjIPIwz5Pn5WbPh/)
-   [Model-View-Controller](/csannex/module/recVsikSMFoQ25WZd/)

<a href="/csannex/sprint/reczMSFEG5pffpADx" class="bd-toc-link">5.  Python/Django III/Career Development</a>

-   [Object-relational mapping](/csannex/module/reccrn1If8mhlIymc/)
-   [Relational Databases](/csannex/module/recU6Q1DLISGvt0dk/)

<a href="/csannex/sprint/recTTpwFpgZXtPG2o" class="bd-toc-link">6.  Project Week: Cellular Automata</a>

-   [Game of Life](/csannex/module/rec42j1bkTmC0Hsro/)

<a href="/csannex/sprint/recqkHjNcXzK5DTqd" class="bd-toc-link">7.  C Programming Topics</a>

-   [Introduction To C](/csannex/module/recLymrrD7f46rdBa/)
-   [Processes and System Calls](/csannex/module/rec7YmMV7ukDLK770/)
-   [Scheduling](/csannex/module/recfiYtQDLFXGOBFA/)
-   [Operating Systems](/csannex/module/recHPT5QiPS6NOCgz/)
-   [Web Server I](/csannex/module/recz76g3pcHs88Dax/)
-   [Web Server II](/csannex/module/recFGnBVmKCyR0427/)
-   [Theory of Computation](/csannex/module/recH0OAnSr6ZcnZ7F/)

-   [Prepare](#prepare)
-   [Learn](#learn)
-   [Review](#review)

# Building APIs

<span class="lead"> </span>

The back-end of a web application is responsible for exposing an API that allows the front-end to create, read, update, and delete data (CRUD).

Representational State Transfer (REST) has been the dominant approach for API design, and is still a friendly and useful technique for applications that mostly work with single entities. REST is more of a style than a strict standard, but is most characterized by having stateless operations (a request does not depend or even know about preceding requests) and extending standard HTTP methods with a noun-verb paradigm to support CRUD operations on database entities.

**At the end of this module, you should be able to:**

-   set up the Django REST Framework and connect a model to an endpoint
-   control which information is exposed based on the currently-logged-in user
-   use token authorization to assign correct permissions to various users

#### Pro Tip

A witty saying proves nothing.

Voltaire

## <a href="#prepare" id="prepare" class="anchor"><span class="octicon octicon-link"></span></a>Prepare

Review each preclass resource before class.

-   

    # An error occurred.

    [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=u_k8_bZrFD8), or enable JavaScript if it is disabled in your browser.

-   

    # An error occurred.

    [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=Ri79BRr8BCI), or enable JavaScript if it is disabled in your browser.

-   

    # An error occurred.

    [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=JNW0yfbsKpA), or enable JavaScript if it is disabled in your browser.

## <a href="#learn" id="learn" class="anchor"><span class="octicon octicon-link"></span></a>Learn

#### Learn to set up the Django REST Framework and connect a model to an endpoint

Django comes with a powerful REST framework that makes it easy to expose models via an API. This makes it a powerful contender for quick implementation of REST backends.

##### Overview

There are two phases to exposing a model via a REST API. First, we need to tell which fields of the model we want to share, as well as which records from the database we need.

Once we’ve defined the data we also have to expose an endpoint so clients can hit our API and extract data.

Like we’ve seen before, one of Django’s great strengths is how it creates beautiful, full-features admin UIs for us to use out of the box.

Not only does it do this for the `admin/` endpoint, but now that we’ve exposed a REST API, we have a full-features UI for GETting data and POSTing new records.

First we’ll install the Django REST framework and do some boilerplate config.

Following that, we need to tell Django that we’re interested in exposing data for a particular model. We do this through the use Django `Serializer`s and `ViewSet`s.

One that is set up, we finally use the REST framework’s `routers` functionality to automatically hook the `Serializer` up to a specific URL endpoint.

##### Follow Along

#### Installing the REST Framework

We’ll be using the django REST framework: http://www.django-rest-framework.org/

Open the shell if you aren’t in it and install the framework:

    pipenv install djangorestframework

Next, we need to tell the project about this. Open `[name_of_project]/settings.py`

Under `INSTALLED_APPS` add `'rest_framework'` to the list.

We also need to add some boilerplate to set up permissions:

    REST_FRAMEWORK = {
        'DEFAULT_PERMISSION_CLASSES': [
            'rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly',
        ]
    }

This will allow read/write permissions for logged in users and read only for anonymous users.

Launch the server and make sure everything is working, debug, and commit.

#### Expose the PersonalNotes Model

Next, we need to add more boilerplate. In the `notes` folder, create a new file called `api.py`. This will use something called serializers and viewsets to describe which parts of the model we want to expose to the API.

First, in `api.py`, import the serializers:

    from rest_framework import serializers

We’ll also need to import the `PersonalNote` class so that we can use it here.

Convention is to name the serializer classes after what they are serializing. It will inherit from the specific serializer we are using for this project:

    class PersonalNoteSerializer(serializers.HyperlinkedModelSerializer):

Inside this class, we will make an *inner class* (nested class) called a `Meta` to tell it what parts of the model we want to access:

        # Inner class nested inside PersonalNoteSerializer
        class Meta:
            model = PersonalNote
            fields = ('title', 'content')

To visualize this, we will use something called a viewset. Add `viewsets` to what is being imported from `rest_framework`:

    from rest_framework import serializers, viewsets

Create a new class for this, using the same naming convention as the serializer and inheriting from `viewsets.ModelViewSet`

    class PersonalNoteViewSet(viewsets.ModelViewSet):

Link this back to the serializer class we made previously:

        serializer_class = PersonalNoteSerializer

Next, add which records to search for. We could use filters here, but for now, grab all of them:

    queryset = PersonalNote.objects.all()

There isn’t anything we can check just yet to ensure that this is working, but let’s make sure we haven’t broken anything.

At this point, we should have:

    from rest_framework import serializers, viewsets
    from .models import PersonalNote

    class PersonalNoteSerializer(serializers.HyperlinkedModelSerializer):

        class Meta:
            model = PersonalNote
            fields = ('title', 'content')

    class PersonalNoteViewSet(viewsets.ModelViewSet):
        serializer_class = PersonalNoteSerializer
        queryset = PersonalNote.objects.all()

Run the server, debug, commit.

#### Add Routes

Lastly, we need to add a route to be able to access this functionality. In the project folder, open `urls.py`.

We’ll need to import two things here: router functionality for Django, and the `PersonalNoteViewSet` we just created.

    from rest_framework import routers
    from notes.api import PersonalNoteViewSet

Next, make a default router from the routers package, then register that router:

    router = routers.DefaultRouter()
    router.register(r'notes', PersonalNoteViewSet)

This is similar to setting up a route in express, but we’re saying for this route, this (`PersonalNoteViewSet`) is the data we want to associate with it. (The `r` means that this is a regular expression, and to interpret the string as literally as possible–somewhat overkill in this case.)

Next, we need to add the URL to the `urlpatterns` list. In order to do that, we’ll be using a function called `include()` that we get from `django.urls`:

    from django.urls import path, include

And in `urlpatterns`:

        path('api/', include(router.urls)),

This will set the path to `/api/notes`. We can use `router.register` to add as many paths as we want this way, without needing to add them to `urlpatterns`

#### Test the API

Run the server, navigate to `/api/` and review the information there. Click the link to `notes` and review that as well.

Use the admin feature at the bottom to attempt to post a new note. This will fail.

The reason is that our `PersonalNote` model requires a username as well. We need to add that in.

##### Challenge

-   Expose another model through a different endpoint than we covered in the example.

------------------------------------------------------------------------

#### Learn to control which information is exposed based on the currently-logged-in user

So far we’ve just exposed *all* the data from a model to the entire world. But commonly it’s desirable to restrict access to data on a per-user basis. We’ll set that up with some additional Python code.

##### Overview

If we try to POST a new record to the database, we see that it’s missing the required `user` field (since it doesn’t show up in the UI). We’ll retrieve this data from the web request and add it to the record before posting.

Once we do that, we can:

-   Show no results if the user isn’t logged in.
-   Show only pertinent results to logged-in users.

First, we’ll override the `create` method in our `Serializer` so that we can add fields in addition to whatever was present in the UI form. Notably, we wish to add the user information.

We can use the built-in debugger to explore and see what fields are at our disposal.

Once we find where the user is stored in the request, we can pass that data into our model constructor and get a complete object to return from `create`.

Lastly, we can also override the list of results that we pass back for a GET request. Currently we have it set to return everything, but we’ll modify this to return nothing when the user isn’t logged in, and only the user’s information when they are logged in.

Django’s ORM filters make it easy to filter results.

##### Follow Along

#### Add the Required `user` Field, Use the Debugger

We can do that in our serializer by overriding a method from `serializers.HyperlinkedModelSerializer` called `create`. This method needs to return a new `PersonalNote` object constructed from the passed-in data, which is in the `validated_data` parameter, like so by default:

In `api.py`, `PersonalNoteSerializer`:

        # !!! Broken code still missing the user field

        def create(self, validated_data):
            note = PersonalNote.objects.create(**validated_data)
            return note

But we need to add the `user` field into the mix. If the user is logged in to Django through this browser, that information is automatically included in the request… but where? Let’s use the debugger to explore and find out.

In `api.py`, `PersonalNoteSerializer`:

        def create(self, validated_data):
            import pdb; pdb.set_trace()  # Start the debugger here
            pass

Run this and use the debugger to the data present at this breakpoint. If you dig into `self`, you will find eventually find a context with a request. As an educated guess, using what we’ve previously learned about requests, it is fair to hypothesize that a user is associated with the request. Try it out:

    self.context[‘request’].user

Exit the debugger and add a new variable in `create` to store the user retrieved from the location in `self` that we just discovered. Feed it in to `PersonalNote.objects.create` as an additional keyword argument:

        def create(self, validated_data):
            user = self.context[‘request’].user
            note = PersonalNote.objects.create(user=user, **validated_data)
            return note

This will add the needed data to the create method and allow the form to work. Return to the `/api/notes/` page and test.

You will receive a `201 Created` that may appear at first as if the data is being overwritten. Return to the main list page to confirm that everything is being saved.

Debug as needed, then commit.

#### Filter Results by User

Finally, we have one major problem remaining. Right now, any user can request and see all of the notes that are in the database. We need to filter them so that only the appropriate ones are returned. Return to `api.py`, `PersonalNoteViewSet`.

Change `queryset` to initialize with `Note.objects.none()`. This will create the variable with an empty dictionary of the correct type. To make a decision based on whether or not the user is anonymous, and return only the notes that belong to the logged in user, we can override a method called `get_queryset(self)`.

Load the user into a variable. This class has access to the `request` directly, so it can be found with `self.request.user`.

        def get_queryset(self):
            user = self.request.user

If `user.is_anonymous`, we can return an empty dictionary of notes. Otherwise, we can use a filter to return only the correct ones with `Note.objects.filter(user=user)`.

        def get_queryset(self):
            user = self.request.user

            if user.is_anonymous:
                return PersonalNote.objects.none()
            else:
                return PersonalNote.objects.filter(user=user)

Test, debug, and commit.

#### Set up CORS

In order to get your site to run well with a front-end, you might need to set up CORS:

https://github.com/ottoyiu/django-cors-headers

After installation, setting:

    CORS_ORIGIN_ALLOW_ALL = True

should be enough.

##### Challenge

-   Change another endpoint to show no data if the user is not logged in.

------------------------------------------------------------------------

#### Learn to use token authorization to assign correct permissions to various users

Since REST clients can’t use our login UI to set which user they are, they have to use an alternate method of authentication. In this portion of the code, we’ll use *token authentication* to allow the user to log in via a new endpoint, and use that to control their access.

Although our REST calls will now transmit tokens (randomish strings of data) to authenticate, Django will seamless transform those to user objects on the back end so our login code will still operate without modification.

##### Overview

The first step is to set up an endpoint for logging in. The user will submit the username and password, and then get a token back. We can then use this token to access other parts of the REST API.

We’ll add some minor boilerplate that lets Django’s REST Framework know that we want to use token authentication.

After that, we add a path to `urls.py` and hook that up to the authentication system. Django takes care of the details.

We can test it on the command line with the `curl` utility or with Postman.

Once we have our token, we can deliver it as part of the HTTP headers in subsequent API requests, and we’ll be effectively logged in.

##### Follow Along

The Django Rest Framework also provides token authorization. We will use this to allow other users to login and access the data specific to them. Information can be found here:

http://www.django-rest-framework.org/api-guide/authentication/#authentication

###### Set up Token Authentication

Open `settings.py`.

To `INSTALLED_APPS`, add `rest_framework.authtoken`.

If you need them elsewhere, immediately before the boilerplate for `REST_FRAMEWORK`, import `SessionAuthentication`, `BasicAuthentication`, and `TokenAuthentication` from `rest_framework.authentication`

    from rest_framework.authentication import SessionAuthentication, BasicAuthentication, TokenAuthentication

In `REST_FRAMEWORK`, add:

        'DEFAULT_AUTHENTICATION_CLASSES': (
            'rest_framework.authentication.BasicAuthentication',
            'rest_framework.authentication.SessionAuthentication',
            'rest_framework.authentication.TokenAuthentication',
        ),

###### Set up the Route

Next, we need to set up the route to authenticate users. In `urls.py`:

Import `re_path` from `django.urls` and `views` from `rest_framework.authtoken`

    from django.urls import path, include, re_path
    from rest_framework.authtoken import views

Then add the endpoint in `urls.py` by adding the `api-token-auth/` route to `urlpatterns`:

        re_path(r'^api-token-auth/', views.obtain_auth_token)

The `^` is means “match the beginning of the string” in a regular expression. The `re_path` function is just like `path`, except it interprets the endpoint as a regex instead of a fixed string.

Do a migration to set up the database.

###### Test the Endpoint

We can test this on the bash command line with the [curl](https://curl.haxx.se/) utility that you might already have installed. (Postman also works.)

Mac/Linux:

    ### The following makes a POST request with the given JSON payload:

    curl -X POST -H "Content-Type: application/json" -d '{"username":"admin", "password":"PASSWORD"}' http://127.0.0.1:8000/api-token-auth/

Windows (or other platform if the above doesn’t work):

    ### Windows needs some more double quotes and escaping of the payload

    curl -X POST -H "Content-Type: application/json" -d "{\"username\":\"admin\", \"password\":\"PASSWORD\"}" http://127.0.0.1:8000/api-token-auth/

PowerShell has its own thing independent of `curl`:

    Invoke-WebRequest http://localhost:8000/api-token-auth/ -Method Post -ContentType "application/json" -Body '{"username":"USER", "password":"PASS"}' -UseBasicParsing

If you get back a very large amount of html and other text, you have an error. Scroll back up and google the error displayed just under your console command for help troubleshooting. Many of the errors you can get here are easy to do, common, and relatively easy to google for information on how to fix.

You should get back one line with a token, for example:

    {"token":"da51ccf5274050cd7332d184246d7d0775dc79e2"}

Your token will be different. Try it out with your token:

    curl -v -H 'Authorization: Token da51ccf5274050cd7332d184246d7d0775dc79e2' http://127.0.0.1:8000/api/notes/

Note that the trailing `/` matters. You will get a 301 redirect if you don’t add it here.

When using Axios to send the request, set the header here:

    axios.post('http://127.0.0.1:8000/api/notes/', data, {
      headers: {
        'Authorization': 'Token da51ccf5274050cd7332d184246d7d0775dc79e2',
      }
    }

##### Challenge

-   There are other kinds of authentication you can add. Research these.

-   Add session authentication, as well.

------------------------------------------------------------------------

## <a href="#review" id="review" class="anchor"><span class="octicon octicon-link"></span></a>Review

### Class Recordings

You can use class recordings to help you master the material.

-   **[Intro to Django Day 4 for CS13 w/ Brady Fukumoto](https://youtu.be/DslDD-2NSM8)**

    Brady reviews more Django and talks about Heroku deployment and the upcoming LambdaMUD project

-   [All previous recordings](/archive/CSAnnex/module/recuEEEsf9eXphxy0)

### Demonstrate Mastery

To demonstrate mastery of this module, you need to complete and pass a code review on each of the following:

-   Objective challenge:
    -   Expose another model through a different endpoint than we covered in the example.
-   Objective challenge:
    -   Change another endpoint to show no data if the user is not logged in.
-   Objective challenge:
    -   There are other kinds of authentication you can add. Research these.

    -   Add session authentication, as well.
