Please enable JavaScript to view this page.

You must be logged in to view this page.

You must be a Lambda School student to view this page.

<a href="#content" id="skippy" class="sr-only sr-only-focusable"></a>

<span class="skiplink-text">Skip to main content</span>

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMyIgaGVpZ2h0PSIzNSIgdmlld2JveD0iMCAwIDMzIDM1IiBmaWxsPSJub25lIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0wIDBWMTYuMDYwOUMwIDI3LjczMzUgOS4wODkyOSAzMS43ODQzIDE1LjczMjEgMzQuNzUxM0gxNS43NUwxNi4yODU3IDM1QzE2LjQxMDcgMzQuOTI4OSAxNi41MzU3IDM0Ljg3NTYgMTYuNjc4NiAzNC44MjIzQzE2Ljc1IDM0Ljc4NjggMTYuODM5MyAzNC43NTEzIDE2LjkxMDcgMzQuNzE1N0MyMy41NzE0IDMxLjc2NjUgMzIuNjk2NCAyNy42OTggMzIuNjk2NCAxNi4wNjA5VjBIMFpNMjAuNzA3MSAyMy40NTM2TDIwLjM1NzEgMjIuNTEwMkwxNS42MDcxIDEwLjA3MzZDMTUuMzIxNCAxMC44MDIgMTQuNjYwNyAxMi41NjA5IDEzLjk0NjQgMTQuNDQ0MkwxMS4yMTQzIDIxLjc4MTdDMTEuMDg5MyAyMi4xMzcxIDExLjE2MDcgMjIuMzE0NyAxMS4yNSAyMi40MzkxQzExLjQ0NjQgMjIuNjcwMSAxMS44NzY4IDIyLjY3MDEgMTIuNTU1NCAyMi42NzAxSDEyLjY3ODZMMTIuNjc2OCAyMy40NTE4SDcuNTY5NjRWMjIuNjcwMUg3Ljk2MjVDOC42NTg5MyAyMi42NzAxIDkuMjMwMzYgMjIuMzY4IDkuNjU4OTMgMjEuNTE1MkwxMC4xNzY4IDIwLjM0MjZMMTQuOTA4OSA4LjI5Njk2TDE0LjA2OTYgNi4wNzYxNEgxOC40ODA0TDI0LjU2OTYgMjIuMDEyN0wyNS4xMjUgMjMuNDUzNkgyMC43MDcxWiIgZmlsbD0iI0VDMzk0NCI+PC9wYXRoPgo8L3N2Zz4=" /></a>

![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdib3g9IjAgMCAzMCAzMCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmb2N1c2FibGU9ImZhbHNlIj48dGl0bGU+TWVudTwvdGl0bGU+PHBhdGggc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBkPSJNNCA3aDIyTTQgMTVoMjJNNCAyM2gyMiI+PC9wYXRoPjwvc3ZnPg==)

#### Web Annex

<a href="/webannex/sprint/recfwZvI7QhMa7xbG" class="bd-toc-link">1.  User Interface and Git</a>

- [User Interface](/webannex/module/recl0IyzS2Vl89lZa/)
- [Git for Web Development](/webannex/module/rect59e95N6OSvoCd/)
- [User Interface II](/webannex/module/recGvXyWT6AvGtMHR/)
- [User Interface III](/webannex/module/recaVbBZhh8BTyMdM/)

<a href="/webannex/sprint/recIXiQgpgMdJ81ms" class="bd-toc-link">2.  Advanced CSS</a>

- [Responsive Design I](/webannex/module/recuDrqSGpWcepCMs/)
- [Responsive Design II](/webannex/module/recE3IqPtDxaVI0DW/)
- [Preprocessing I](/webannex/module/reculyBhIYkuoBRqh/)
- [Preprocessing II](/webannex/module/rec1hRu3bO6L0uxn2/)

<a href="/webannex/sprint/recclZwJxMU8kUngT" class="bd-toc-link">3.  JavaScript Fundamentals</a>

- [JavaScript I](/webannex/module/recCT3KJYTIRYwQMh/)
- [JavaScript II](/webannex/module/rec1oaBmEoSilO2yf/)
- [Prototypes and Inheritance](/webannex/module/rec0AWuNLezbpit7m/)
- [Classes](/webannex/module/recyS588eOvVUKAMc/)

<a href="/webannex/sprint/recRT8JKvbTiGaosk" class="bd-toc-link">4.  Single Page Applications</a>

- [React Router I](/webannex/module/rec2TJ1vrdfcnx2EG/)
- [React Router II](/webannex/module/recYkF1FDilIedmwX/)
- [Form Management](/webannex/module/rect081xiYT2cfxGF/)
- [Advanced Form Management](/webannex/module/recKK5C7wV0WiECfr/)

<a href="/webannex/sprint/recozTHaHJe6L1ThN" class="bd-toc-link">5.  Authentication and Testing</a>

- [Introduction to Authentication](/webannex/module/recQD9lnhqWEFh6g4/)
- [Using Sessions and Cookies](/webannex/module/recvIPgHwxF194c7q/)
- [Using JSON Web Tokens (JWT)](/webannex/module/reciCHdNjavSKaaLt/)
- [Testing the Back End](/webannex/module/reciXdxRA8zXJXDID/)

<a href="/" class="navbar-brand"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM1IiBoZWlnaHQ9IjM1IiB2aWV3Ym94PSIwIDAgNzU2IDE5NyIgZmlsbD0iI2VjMzk0NCI+PGc+PHBhdGggZD0iTTI5Mi45LDEyNi42aC02LjdjLTksMC0xMi42LTEuOS0xMi42LTkuNVY0OC41YzAtNy43LDEuNi04LjYsMTEuNC05Ljd2LTQuNWgtNDEuM3Y0LjUgYzkuOCwxLjEsMTEuNCwxLjksMTEuNCw5Ljd2NjkuM2MwLDcuNy0xLjYsOC42LTExLjQsOS43djQuNWg3My43bDQuOS0yOS40aC00LjRDMzA4LjUsMTE5LjYsMzAzLjksMTI2LjYsMjkyLjksMTI2LjZ6Ij48L3BhdGg+PHBhdGggZD0iTTM4NS41LDEyMS4xVjc5LjNjMC0xNS44LTkuNC0yMi40LTI2LjYtMjIuNGMtMTUsMC0yNi44LDYuNi0yNi44LDE5LjNjMCwyLjQsMC4yLDMuMywwLjgsNWgxNi42IGMtMC41LTItMC43LTUtMC43LTcuNWMwLTkuNiwzLjYtMTIuNCw5LjQtMTIuNGM2LjQsMCw5LjcsMiw5LjcsMTQuNHYxMS4ybC0yMC44LDcuN2MtMTAuNiw0LjEtMTkuMyw4LjgtMTkuMywyMC43IGMwLDEwLjksNy41LDE3LjgsMTguNiwxNy44YzkuOSwwLDE3LjQtNi4yLDIxLjktMTIuMWwwLjEtMC4xbDAsMFYxMzJoMjZ2LTQuNEMzODcuNywxMjcuMSwzODUuNSwxMjYuMiwzODUuNSwxMjEuMXogTTM2OCwxMTcuOCBjLTQuNCwzLjMtNy42LDUuMy0xMiw1LjRjLTcuNywwLTExLjItNS4yLTExLjItMTIuNmMwLTcuNywzLjYtMTEuMiw5LjgtMTMuNWwxMy40LTUuNFYxMTcuOEwzNjgsMTE3Ljh6Ij48L3BhdGg+PHBhdGggZD0iTTUxNC40LDEyMVY3OS41YzAtMTQuOC02LTIyLjQtMTguNy0yMi40Yy0xMS41LDAtMTkuNCw2LjYtMjUuNSwxMy45Yy0xLjgtOS42LTcuNy0xMy45LTE3LjgtMTMuOSBjLTExLjQsMC0xOC43LDYuMi0yNC44LDEzLjZWNTdoLTIuM2wtMjMuOCw3LjR2Mi40bDguNiw1djQ5LjRjMCw1LTIuMSw2LjEtOC45LDYuNHY0LjRoMzUuMXYtNC40Yy02LjctMC4zLTguNy0xLjMtOC43LTYuNHYtNDcgYzQuNy0zLjYsOS41LTYuNSwxNS41LTYuNWM3LjYsMCwxMC41LDQuMiwxMC41LDEyLjd2NDAuOGMwLDUtMS45LDYuMS04LjcsNi40djQuNGwzNC44LDB2LTQuNGMtNi43LTAuMy04LjYtMS4zLTguNi02LjR2LTQ3IGM0LjctMy42LDkuNS02LjUsMTUuNS02LjVjNy42LDAsMTAuNSw0LjIsMTAuNSwxMi43bC0wLjEsNDAuNWMwLDUtMS44LDYuNC04LjYsNi43bDAsNC40aDM1LjF2LTQuNCBDNTE2LjcsMTI3LjQsNTE0LjQsMTI2LjEsNTE0LjQsMTIxeiI+PC9wYXRoPjxwYXRoIGQ9Ik01NzMuMiw1Ny4zYy0xMSwwLTE4LjUsNS43LTIzLjQsMTIuOFYyMi45aC0yLjdsLTIzLjQsNi44djIuNWw4LjYsNC41VjEzMmgyLjlsOC0zLjVjNS44LDMuMywxMi4zLDUsMjAuMiw1IGMyMC44LDAsMzcuNC0xNS44LDM3LjQtNDIuNkM2MDAuOSw2OS45LDU5MC40LDU3LjMsNTczLjIsNTcuM3ogTTU2My40LDEyOC43Yy01LjQsMC0xMC4zLTIuNC0xMy43LTcuOVY3My42IGMzLjQtMy40LDguNS01LjcsMTMuNS01LjdjMTMuOSwwLDIwLDEyLjgsMjAsMjkuNUM1ODMuMywxMTQuNyw1NzUuOCwxMjguNSw1NjMuNCwxMjguN3oiPjwvcGF0aD48cGF0aCBkPSJNNjc3LDEyMS4yVjIyLjhoLTIuNkw2NTEsMjkuNlYzMmw4LjYsNC41djI1LjdjLTMuNC0zLjItOC44LTUuMS0xNS41LTUuMWMtMTkuOSwwLTM1LjIsMTUuMy0zNS4yLDQxLjMgYzAsMjAuNywxMS4yLDM0LjYsMjguMSwzNC42YzkuOCwwLDE3LTUuMywyMi42LTEzLjF2MC45VjEzMmgyNi4zbDAtNC40QzY3OS4xLDEyNy4zLDY3NywxMjYuMyw2NzcsMTIxLjJ6IE02NTkuNiwxMTcuMSBMNjU5LjYsMTE3LjFjLTMuNCwzLjQtOCw1LjEtMTMuMiw1LjFjLTEzLjIsMC0yMC40LTEyLjgtMjAuNC0yOS44YzAtMTcuOCw3LjMtMjkuMiwxOS41LTI5LjJjOC43LDAsMTQuMSw2LjksMTQuMSwxOC4zIEw2NTkuNiwxMTcuMXoiPjwvcGF0aD48cGF0aCBkPSJNNzQ3LjEsMTIxLjFWNzkuM2MwLTE1LjgtOS40LTIyLjQtMjYuNi0yMi40Yy0xNSwwLTI2LjgsNi42LTI2LjgsMTkuM2MwLDIuNCwwLjIsMy4zLDAuOCw1aDE2LjYgYy0wLjUtMi0wLjctNS0wLjctNy41YzAtOS42LDMuNi0xMi40LDkuNC0xMi40YzYuNCwwLDkuNywyLDkuNywxNC40djExLjJsLTIwLjgsNy43Yy0xMC42LDQuMS0xOS4zLDguOC0xOS4zLDIwLjcgYzAsMTAuOSw3LjUsMTcuOCwxOC42LDE3LjhjOS45LDAsMTcuNC02LjIsMjEuOS0xMi4xdi0wLjFoMC4xbDAsMTEuMWwyNiwwLjF2LTQuNUM3NDkuMywxMjcuMSw3NDcuMSwxMjYuMiw3NDcuMSwxMjEuMXogTTcyOS42LDExNy44Yy00LjQsMy4zLTcuNiw1LjMtMTIuMSw1LjRjLTcuNywwLTExLjItNS4yLTExLjItMTIuNmMwLTcuNywzLjYtMTEuMiw5LjgtMTMuNWwxMy40LTUuNEw3MjkuNiwxMTcuOEw3MjkuNiwxMTcuOHoiPjwvcGF0aD48L2c+PHBhdGggZD0iTTAsMHY5MC40YzAsNjUuNyw1MC45LDg4LjUsODguMSwxMDUuMmgwLjFsMywxLjRjMC43LTAuNCwxLjQtMC43LDIuMi0xYzAuNC0wLjIsMC45LTAuNCwxLjMtMC42IGMzNy4zLTE2LjYsODguNC0zOS41LDg4LjQtMTA1VjBIMHogTTExNiwxMzJsLTItNS4zbC0yNi42LTcwYy0xLjYsNC4xLTUuMywxNC05LjMsMjQuNmwtMTUuMyw0MS4zYy0wLjcsMi0wLjMsMywwLjIsMy43IGMxLjEsMS4zLDMuNSwxLjMsNy4zLDEuM0g3MWwwLDQuNEg0Mi40bDAtNC40aDIuMmMzLjksMCw3LjEtMS43LDkuNS02LjVsMi45LTYuNmwyNi41LTY3LjhsLTQuNy0xMi41aDI0LjdsMzQuMSw4OS43bDMuMSw4LjFIMTE2eiI+PC9wYXRoPjwvc3ZnPg==" /></a>

#### Web Annex

<a href="/webannex/sprint/recfwZvI7QhMa7xbG" class="bd-toc-link">1.  User Interface and Git</a>

- [User Interface](/webannex/module/recl0IyzS2Vl89lZa/)
- [Git for Web Development](/webannex/module/rect59e95N6OSvoCd/)
- [User Interface II](/webannex/module/recGvXyWT6AvGtMHR/)
- [User Interface III](/webannex/module/recaVbBZhh8BTyMdM/)

<a href="/webannex/sprint/recIXiQgpgMdJ81ms" class="bd-toc-link">2.  Advanced CSS</a>

- [Responsive Design I](/webannex/module/recuDrqSGpWcepCMs/)
- [Responsive Design II](/webannex/module/recE3IqPtDxaVI0DW/)
- [Preprocessing I](/webannex/module/reculyBhIYkuoBRqh/)
- [Preprocessing II](/webannex/module/rec1hRu3bO6L0uxn2/)

<a href="/webannex/sprint/recclZwJxMU8kUngT" class="bd-toc-link">3.  JavaScript Fundamentals</a>

- [JavaScript I](/webannex/module/recCT3KJYTIRYwQMh/)
- [JavaScript II](/webannex/module/rec1oaBmEoSilO2yf/)
- [Prototypes and Inheritance](/webannex/module/rec0AWuNLezbpit7m/)
- [Classes](/webannex/module/recyS588eOvVUKAMc/)

<a href="/webannex/sprint/recRT8JKvbTiGaosk" class="bd-toc-link">4.  Single Page Applications</a>

- [React Router I](/webannex/module/rec2TJ1vrdfcnx2EG/)
- [React Router II](/webannex/module/recYkF1FDilIedmwX/)
- [Form Management](/webannex/module/rect081xiYT2cfxGF/)
- [Advanced Form Management](/webannex/module/recKK5C7wV0WiECfr/)

<a href="/webannex/sprint/recozTHaHJe6L1ThN" class="bd-toc-link">5.  Authentication and Testing</a>

- [Introduction to Authentication](/webannex/module/recQD9lnhqWEFh6g4/)
- [Using Sessions and Cookies](/webannex/module/recvIPgHwxF194c7q/)
- [Using JSON Web Tokens (JWT)](/webannex/module/reciCHdNjavSKaaLt/)
- [Testing the Back End](/webannex/module/reciXdxRA8zXJXDID/)

- [Prepare](#prepare)
- [Learn](#learn)
- [Guided Project](#guided-project)
- [Project](#project)
- [Review](#review)

# Using Sessions and Cookies

<span class="lead"> </span>

The HTTP protocol, and by extension the web, is stateless. It has no memory across requests. By default whenever we change pages all previous information the server had about the client is lost, this includes authentication information.

Imagine logging into your favorite server and as soon as you change pages the server asks you to login again as it doesn’t _remember_ who you are. That would make for a bad user experience. Fortunately there are ways around this and in this section we’ll take a look at one: **sessions**.

**At the end of this module, you should be able to:**

- use in-memory sessions to persist authentication information across requests
- implement logout using a sessions based API
- restrict access to resources, allowing access only for authenticated users

#### Pro Tip

Remember that everyone around you is human and will make mistakes. Try to build up, not tear down.

## <a href="#prepare" id="prepare" class="anchor"><span class="octicon octicon-link"></span></a>Prepare

Review each preclass resource before class.

- # An error occurred.

  [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=ke85xaOTTqg), or enable JavaScript if it is disabled in your browser.

- # An error occurred.

  [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=aUerI0MXM1I), or enable JavaScript if it is disabled in your browser.

- # An error occurred.

  [Try watching this video on www.youtube.com](https://www.youtube.com/watch?v=0Q3XvKqU8cI), or enable JavaScript if it is disabled in your browser.

- [How do express sessions work?](https://nodewebapps.com/2017/06/18/how-do-nodejs-sessions-work/)

- [express-session package documentation](https://www.npmjs.com/package/express-session)

  How to install and use express-session

## <a href="#learn" id="learn" class="anchor"><span class="octicon octicon-link"></span></a>Learn

#### Learn to use in-memory sessions to persist authentication information across requests

Sessions are commonly used to allow a server to store information about a client. That information can then be used for a variety of purposes.

We’ll use it to persist authentication information so there is no need to re-enter credentials on every new request the client makes to the server.

##### Overview

Sessions provide a way to persist data across requests. We’ll use them to save authentication information, so there is no need to re-enter credentials on every new request the client makes to the server.

When using sessions, **each client will have a unique session** stored on the server.

Now that we have a solution for keeping authentication information, we need a way to transmit that information between the client and server. For that, we’ll use **cookies**.

### Authentication Workflow for sessions

The basic workflow when using a combination of _cookies_ and _sessions_ for authentication is:

- Client sends credentials.
- Server verify credentials.
- Server creates a session for the client.
- Server produces and sends back cookie.
- Client stores the cookie.
- Client sends cookie on every request.
- Server verifies that cookie is valid.
- Server provides access to resource.

To understand how cookies are transmitted and stored in the browser, we need to look at the basic structure of an HTTP message. Every HTTP message, be it a request or a response, has two main parts: the _headers_ and the _body_.

The _headers_ are a set of key/value stores that include information about the request. There are several standard headers, but we can add our own if needed.

To send _cookies_, the server adds the `Set-Cookie` header to the response like so: `"Set-Cookie": "session=12345"`. Notice how the value of a header is just a string. The browser will read the header and save a cookie called `session` with the value `12345` in this example. We will use a library that takes care of creating and sending the cookie.

The _body_ contains the data portion of the message.

The browser will add the `"Cookie": "session=12345"` header on every subsequent request and the server.

Cookies are not accessible from JavaScript or anywhere because they are cryptographically signed and very secure.

There are sever libraries for handling sessions in Node.js, below are two examples:

- [client-sessions](https://www.npmjs.com/package/client-sessions)
- [express-session](https://www.npmjs.com/package/express-session)

We will use the latter.

#### Common ways to store session data on the server:

- Memory.
- Memory cache (like Redis and Memcached).
- Database.

##### Cookies

- Automatically included on every request.
- Unique to each domain + device pair.
- Cannot be sent to a different domain.
- Sent in the cookie header.
- Has a body that can have extra identifying information.
- Max size around 4KB.

##### Storing session data in memory

- Data stored in memory is wiped when the server restarts.
- Causes memory leaks as more and more memory is used as the application continues to store data in session for different clients.
- Good for development due to its simplicity.

##### Using cookies to transfer session data.

Advantages when using cookies:

- a cookie is a small key/value pair data structure that is passed back and forth between client and server and stored in the browser.
- the server uses it to store information about a particular client/user.
- workflow for using cookies as session storage:
  - the server issues a cookie with an expiration time and sends it with the response.
  - browsers automatically store the cookie and send it on every request to the same domain.
  - the server can read the information contained in the cookie (like the username).
  - the server can make changes to the cookie before sending it back on the response.
  - rinse and repeat.

**Express-session uses cookies for session management**.

Drawbacks when using cookies:

- small size, around 4KB.
- sent in every request, increasing the size of the request if too much information is stored in them.
- if an attacker gets a hold of the private key used to encrypt the cookie, they could read the cookie data.

##### Storing session data in Memory Cache (preferred way of storing sessions in production applications)

- stored as key-value pair data in a separate server.
- the server still uses a cookie, but it only contains the session id.
- the memory cache server uses that session id to find the session data.

Advantages:

- Quick lookups.
- Decoupled from the API server.
- A single memory cache server can serve many applications.
- Automatically remove old session data.

Drawbacks:

- another server to set up and manage.
- extra complexity for small applications.
- hard to reset the cache without losing all session data.

##### Storing session data in a database

- Similar to storing data in a memory store.
- The session cookie still holds the session id.
- The server uses the session id to find the session data in the database.
- Retrieving data from a database is slower than reading from a memory cache.
- Causes chatter between the server and the database.
- **Need to manage/remove old sessions manually** or the database will be filled with unused session data. Most libraries now manage this for you.

Here is a list of [express-session compatible stores.](https://github.com/expressjs/session#compatible-session-stores)

##### Follow Along

Let’s add session support to our Web API:

    const session = require('express-session');

    // configure express-session middleware
    server.use(
      session({
        name: 'notsession', // default is connect.sid
        secret: 'nobody tosses a dwarf!',
        cookie: {
          maxAge: 1 * 24 * 60 * 60 * 1000,
          secure: true, // only set cookies over https. Server will not send back a cookie over http.
        }, // 1 day in milliseconds
        httpOnly: true, // don't let JS code access cookies. Browser extensions run JS code on your browser!
        resave: false,
        saveUninitialized: false,
      })
    );

The `resave` option forces the session to be saved back to the session store, even if the session wasn’t modified during the request.

The `saveUninitialized` flag, forces a session that is “uninitialized” to be saved to the store. A session is uninitialized when it is new but not modified. Choosing `false` is useful for implementing login sessions, reducing server storage usage, or **complying with laws that require permission before setting a cookie**.

Now we can store session data in one route handler and read it in another.

    app.get('/', (req, res) => {
      req.session.name = 'Frodo';
      res.send('got it');
    });

    app.get('/greet', (req, res) => {
      const name = req.session.name;
      res.send(`hello ${req.session.name}`);
    });

The server sends back a session id with every response, and the client then sends back that session id on every request.

[`express-session`](https://www.npmjs.com/package/express-session) uses in-memory storage by default.

Note how we generalize the session cookie’s name, to make it harder for attackers to know which library we’re using to manage our sessions. This is akin to using a helmet to hide the `X-Powered-By=Express` header.

##### Challenge

Implement session storage in your Web API using the [client-sessions](https://www.npmjs.com/package/client-sessions) library instead of `express-session`.

---

#### Learn to implement logout using a sessions based API

In this section we’ll see how to implement user logout functionality.

##### Overview

Sessions remain active until they reach the expiration time configured when they were created, but when a user logs out, we need to invalidate the session immediately.

We can do this by removing the session from our session store. Each library does it differently.

##### Follow Along

Add the following code for the logout endpoint:

    server.get('/api/logout', (req, res) => {
      if (req.session) {
        req.session.destroy(err => {
          if (err) {
            res.send('error logging out');
          } else {
            res.send('good bye');
          }
        });
      }
    });

##### Challenge

Implement logout using the [client-sessions](https://www.npmjs.com/package/client-sessions) library instead of `express-session`.

---

#### Learn to restrict access to resources, allowing access only for authenticated users

Most Web APIs will have endpoints that can only be accessed by authenticated clients.

In this section we’ll see how we can use Express local middleware to implement this functionality.

##### Overview

Restricting access to endpoints is a two-step process:

- We write middleware to check that there is a _session_ for the client.
- We place that middleware in front of the endpoints we want to restrict.

##### Follow Along

We’ll start by writing a piece of middleware we can use locally to restrict access to protected routes.

    function protected(req, res, next) {
      if (req.session && req.session.userId) {
        next();
      } else {
        res.status(401).json({ message: 'you shall not pass!!' });
      }
    }

This middleware verifies that we have a session and that the `userId` is set. We could use `username` or any other value to verify access to a resource.

Then, we add that middleware to the endpoints we’d like to protect.

    server.get('/api/users', protected, (req, res) => {
      db('users')
        .then(users => res.json(users))
        .catch(err => res.json(err));
    });

The `/api/users` endpoint is only accessible when the client is logged in.

##### Challenge

Add a piece of global middleware that restricts access to all endpoints, but the `/register` and `/login` endpoints.

---

## <a href="#guided-project" id="guided-project" class="anchor"><span class="octicon octicon-link"></span></a>Guided Project

### Node Auth 2 Guided Project

Starter code for Node Auth 2 guided project

[GitHub Repo](https://github.com/LambdaSchool/node-auth2-guided)

---

## <a href="#project" id="project" class="anchor"><span class="octicon octicon-link"></span></a>Project

- ##### [Web Auth 1 Module Project](https://github.com/LambdaSchool/node-auth1-project)

  Afternoon project for “Node Auth 1” Module

## <a href="#review" id="review" class="anchor"><span class="octicon octicon-link"></span></a>Review

### Class Recordings

You can use class recordings to help you master the material.

- **[Using Sessions and Cookies for WEB26 w/ Luis Hernandez](https://youtu.be/lzL0H0ceJXo)**

  The HTTP protocol, and by extension the web, is stateless. It has no memory across requests. By default whenever we change pages all previous information the server had about the client is lost, this includes authentication information. Imagine logging into your favorite server and as soon as you change pages the server asks you to login again as it doesn’t remember who you are. That would make for a bad user experience. Fortunately there are ways around this and in this section we’ll take a look at one: sessions.

- [All previous recordings](/archive/FSW/module/recvIPgHwxF194c7q)

### Demonstrate Mastery

To demonstrate mastery of this module, you need to complete and pass a code review on each of the following:

- Objective challenge:

  Implement session storage in your Web API using the [client-sessions](https://www.npmjs.com/package/client-sessions) library instead of `express-session`.

- Objective challenge:

  Implement logout using the [client-sessions](https://www.npmjs.com/package/client-sessions) library instead of `express-session`.

- Objective challenge:

  Add a piece of global middleware that restricts access to all endpoints, but the `/register` and `/login` endpoints.

- Guided Project: Node Auth 2 Guided Project

- Project: Web Auth 1 Module Project

- Code Challenge: DigitsRaisedToConsecutivePowers

- Code Challenge: LogicGates
